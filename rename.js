const inArg = $arguments;

const FG = ['ğŸ‡­ğŸ‡°','ğŸ‡²ğŸ‡´','ğŸ‡¹ğŸ‡¼','ğŸ‡¯ğŸ‡µ','ğŸ‡°ğŸ‡·','ğŸ‡¸ğŸ‡¬','ğŸ‡ºğŸ‡¸','ğŸ‡¬ğŸ‡§','ğŸ‡«ğŸ‡·','ğŸ‡©ğŸ‡ª','ğŸ‡¦ğŸ‡º','ğŸ‡¦ğŸ‡ª','ğŸ‡¦ğŸ‡«','ğŸ‡¦ğŸ‡±','ğŸ‡©ğŸ‡¿','ğŸ‡¦ğŸ‡´','ğŸ‡¦ğŸ‡·','ğŸ‡¦ğŸ‡²','ğŸ‡¦ğŸ‡¹','ğŸ‡¦ğŸ‡¿','ğŸ‡§ğŸ‡­','ğŸ‡§ğŸ‡©','ğŸ‡§ğŸ‡¾','ğŸ‡§ğŸ‡ª','ğŸ‡§ğŸ‡¿','ğŸ‡§ğŸ‡¯','ğŸ‡§ğŸ‡¹','ğŸ‡§ğŸ‡´','ğŸ‡§ğŸ‡¦','ğŸ‡§ğŸ‡¼','ğŸ‡§ğŸ‡·','ğŸ‡»ğŸ‡¬','ğŸ‡§ğŸ‡³','ğŸ‡§ğŸ‡¬','ğŸ‡§ğŸ‡«','ğŸ‡§ğŸ‡®','ğŸ‡°ğŸ‡­','ğŸ‡¨ğŸ‡²','ğŸ‡¨ğŸ‡¦','ğŸ‡¨ğŸ‡»','ğŸ‡°ğŸ‡¾','ğŸ‡¨ğŸ‡«','ğŸ‡¹ğŸ‡©','ğŸ‡¨ğŸ‡±','ğŸ‡¨ğŸ‡´','ğŸ‡°ğŸ‡²','ğŸ‡¨ğŸ‡¬','ğŸ‡¨ğŸ‡©','ğŸ‡¨ğŸ‡·','ğŸ‡­ğŸ‡·','ğŸ‡¨ğŸ‡¾','ğŸ‡¨ğŸ‡¿','ğŸ‡©ğŸ‡°','ğŸ‡©ğŸ‡¯','ğŸ‡©ğŸ‡´','ğŸ‡ªğŸ‡¨','ğŸ‡ªğŸ‡¬','ğŸ‡¸ğŸ‡»','ğŸ‡¬ğŸ‡¶','ğŸ‡ªğŸ‡·','ğŸ‡ªğŸ‡ª','ğŸ‡ªğŸ‡¹','ğŸ‡«ğŸ‡¯','ğŸ‡«ğŸ‡®','ğŸ‡¬ğŸ‡¦','ğŸ‡¬ğŸ‡²','ğŸ‡¬ğŸ‡ª','ğŸ‡¬ğŸ‡­','ğŸ‡¬ğŸ‡·','ğŸ‡¬ğŸ‡±','ğŸ‡¬ğŸ‡¹','ğŸ‡¬ğŸ‡³','ğŸ‡¬ğŸ‡¾','ğŸ‡­ğŸ‡¹','ğŸ‡­ğŸ‡³','ğŸ‡­ğŸ‡º','ğŸ‡®ğŸ‡¸','ğŸ‡®ğŸ‡³','ğŸ‡®ğŸ‡©','ğŸ‡®ğŸ‡·','ğŸ‡®ğŸ‡¶','ğŸ‡®ğŸ‡ª','ğŸ‡®ğŸ‡²','ğŸ‡®ğŸ‡±','ğŸ‡®ğŸ‡¹','ğŸ‡¨ğŸ‡®','ğŸ‡¯ğŸ‡²','ğŸ‡¯ğŸ‡´','ğŸ‡°ğŸ‡¿','ğŸ‡°ğŸ‡ª','ğŸ‡°ğŸ‡¼','ğŸ‡°ğŸ‡¬','ğŸ‡±ğŸ‡¦','ğŸ‡±ğŸ‡»','ğŸ‡±ğŸ‡§','ğŸ‡±ğŸ‡¸','ğŸ‡±ğŸ‡·','ğŸ‡±ğŸ‡¾','ğŸ‡±ğŸ‡¹','ğŸ‡±ğŸ‡º','ğŸ‡²ğŸ‡°','ğŸ‡²ğŸ‡¬','ğŸ‡²ğŸ‡¼','ğŸ‡²ğŸ‡¾','ğŸ‡²ğŸ‡»','ğŸ‡²ğŸ‡±','ğŸ‡²ğŸ‡¹','ğŸ‡²ğŸ‡·','ğŸ‡²ğŸ‡º','ğŸ‡²ğŸ‡½','ğŸ‡²ğŸ‡©','ğŸ‡²ğŸ‡¨','ğŸ‡²ğŸ‡³','ğŸ‡²ğŸ‡ª','ğŸ‡²ğŸ‡¦','ğŸ‡²ğŸ‡¿','ğŸ‡²ğŸ‡²','ğŸ‡³ğŸ‡¦','ğŸ‡³ğŸ‡µ','ğŸ‡³ğŸ‡±','ğŸ‡³ğŸ‡¿','ğŸ‡³ğŸ‡®','ğŸ‡³ğŸ‡ª','ğŸ‡³ğŸ‡¬','ğŸ‡°ğŸ‡µ','ğŸ‡³ğŸ‡´','ğŸ‡´ğŸ‡²','ğŸ‡µğŸ‡°','ğŸ‡µğŸ‡¦','ğŸ‡µğŸ‡¾','ğŸ‡µğŸ‡ª','ğŸ‡µğŸ‡­','ğŸ‡µğŸ‡¹','ğŸ‡µğŸ‡·','ğŸ‡¶ğŸ‡¦','ğŸ‡·ğŸ‡´','ğŸ‡·ğŸ‡º','ğŸ‡·ğŸ‡¼','ğŸ‡¸ğŸ‡²','ğŸ‡¸ğŸ‡¦','ğŸ‡¸ğŸ‡³','ğŸ‡·ğŸ‡¸','ğŸ‡¸ğŸ‡±','ğŸ‡¸ğŸ‡°','ğŸ‡¸ğŸ‡®','ğŸ‡¸ğŸ‡´','ğŸ‡¿ğŸ‡¦','ğŸ‡ªğŸ‡¸','ğŸ‡±ğŸ‡°','ğŸ‡¸ğŸ‡©','ğŸ‡¸ğŸ‡·','ğŸ‡¸ğŸ‡¿','ğŸ‡¸ğŸ‡ª','ğŸ‡¨ğŸ‡­','ğŸ‡¸ğŸ‡¾','ğŸ‡¹ğŸ‡¯','ğŸ‡¹ğŸ‡¿','ğŸ‡¹ğŸ‡­','ğŸ‡¹ğŸ‡¬','ğŸ‡¹ğŸ‡´','ğŸ‡¹ğŸ‡¹','ğŸ‡¹ğŸ‡³','ğŸ‡¹ğŸ‡·','ğŸ‡¹ğŸ‡²','ğŸ‡»ğŸ‡®','ğŸ‡ºğŸ‡¬','ğŸ‡ºğŸ‡¦','ğŸ‡ºğŸ‡¾','ğŸ‡ºğŸ‡¿','ğŸ‡»ğŸ‡ª','ğŸ‡»ğŸ‡³','ğŸ‡¾ğŸ‡ª','ğŸ‡¿ğŸ‡²','ğŸ‡¿ğŸ‡¼','ğŸ‡¦ğŸ‡©','ğŸ‡·ğŸ‡ª','ğŸ‡µğŸ‡±','ğŸ‡¬ğŸ‡º','ğŸ‡»ğŸ‡¦','ğŸ‡±ğŸ‡®','ğŸ‡¨ğŸ‡¼','ğŸ‡¸ğŸ‡¨','ğŸ‡¦ğŸ‡¶','ğŸ‡¬ğŸ‡®','ğŸ‡¨ğŸ‡º','ğŸ‡«ğŸ‡´','ğŸ‡¦ğŸ‡½','ğŸ‡§ğŸ‡²','ğŸ‡¹ğŸ‡±'];
const EN = ['HKG','MAC','TPE','JPN','KOR','SGP','USA','GBR','FRA','DEU','AUS','ARE','AFG','ALB','DZA','AGO','ARG','ARM','AUT','AZE','BHR','BGD','BLR','BEL','BLZ','BEN','BTN','BOL','BIH','BWA','BRA','VGB','BRN','BGR','BFA','BDI','KHM','CMR','CAN','CPV','CYM','CAF','TCD','CHL','COL','COM','COG','COD','CRI','HRV','CYP','CZE','DNK','DJI','DOM','ECU','EGY','SLV','GNQ','ERI','EST','ETH','FJI','FIN','GAB','GMB','GEO','GHA','GRC','GRL','GTM','GIN','GUY','HTI','HND','HUN','ISL','IND','IDN','IRN','IRQ','IRL','IMN','ISR','ITA','CIV','JAM','JOR','KAZ','KEN','KWT','KGZ','LAO','LVA','LBN','LSO','LBR','LBY','LTU','LUX','MKD','MDG','MWI','MYS','MDV','MLI','MLT','MRT','MUS','MEX','MDA','MCO','MNG','MNE','MAR','MOZ','MMR','NAM','NPL','NLD','NZL','NIC','NER','NGA','PRK','NOR','OMN','PAK','PAN','PRY','PER','PHL','PRT','PRI','QAT','ROU','RUS','RWA','SMR','SAU','SEN','SRB','SLE','SVK','SVN','SOM','ZAF','ESP','LKA','SDN','SUR','SWZ','SWE','CHE','SYR','TJK','TZA','THA','TGO','TON','TTO','TUN','TUR','TKM','VIR','UGA','UKR','URY','UZB','VEN','VNM','YEM','ZMB','ZWE','AND','REU','POL','GUM','VAT','LIE','CUW','SYC','ATA','GIB','CUB','FRO','ALA','BMU','TLS'];
const ZH = ['é¦™æ¸¯','æ¾³é—¨','å°æ¹¾','æ—¥æœ¬','éŸ©å›½','æ–°åŠ å¡','ç¾å›½','è‹±å›½','æ³•å›½','å¾·å›½','æ¾³å¤§åˆ©äºš','é˜¿è”é…‹','é˜¿å¯Œæ±—','é˜¿å°”å·´å°¼äºš','é˜¿å°”åŠåˆ©äºš','å®‰å“¥æ‹‰','é˜¿æ ¹å»·','äºšç¾å°¼äºš','å¥¥åœ°åˆ©','é˜¿å¡æ‹œç–†','å·´æ—','å­ŸåŠ æ‹‰å›½','ç™½ä¿„ç½—æ–¯','æ¯”åˆ©æ—¶','ä¼¯åˆ©å…¹','è´å®','ä¸ä¸¹','ç»åˆ©ç»´äºš','æ³¢æ–¯å°¼äºšå’Œé»‘å¡å“¥ç»´é‚£','åšèŒ¨ç“¦çº³','å·´è¥¿','è‹±å±ç»´äº¬ç¾¤å²›','æ–‡è±','ä¿åŠ åˆ©äºš','å¸ƒåŸºçº³æ³•ç´¢','å¸ƒéš†è¿ª','æŸ¬åŸ”å¯¨','å–€éº¦éš†','åŠ æ‹¿å¤§','ä½›å¾—è§’','å¼€æ›¼ç¾¤å²›','ä¸­éå…±å’Œå›½','ä¹å¾—','æ™ºåˆ©','å“¥ä¼¦æ¯”äºš','ç§‘æ‘©ç½—','åˆšæœ(å¸ƒ)','åˆšæœ(é‡‘)','å“¥æ–¯è¾¾é»åŠ ','å…‹ç½—åœ°äºš','å¡æµ¦è·¯æ–¯','æ·å…‹','ä¸¹éº¦','å‰å¸ƒæ','å¤šç±³å°¼åŠ å…±å’Œå›½','å„ç“œå¤šå°”','åŸƒåŠ','è¨å°”ç“¦å¤š','èµ¤é“å‡ å†…äºš','å„ç«‹ç‰¹é‡Œäºš','çˆ±æ²™å°¼äºš','åŸƒå¡ä¿„æ¯”äºš','æ–æµ','èŠ¬å…°','åŠ è“¬','å†ˆæ¯”äºš','æ ¼é²å‰äºš','åŠ çº³','å¸Œè…Š','æ ¼é™µå…°','å±åœ°é©¬æ‹‰','å‡ å†…äºš','åœ­äºšé‚£','æµ·åœ°','æ´ªéƒ½æ‹‰æ–¯','åŒˆç‰™åˆ©','å†°å²›','å°åº¦','å°å°¼','ä¼Šæœ—','ä¼Šæ‹‰å…‹','çˆ±å°”å…°','é©¬æ©å²›','ä»¥è‰²åˆ—','æ„å¤§åˆ©','ç§‘ç‰¹è¿ªç“¦','ç‰™ä¹°åŠ ','çº¦æ—¦','å“ˆè¨å…‹æ–¯å¦','è‚¯å°¼äºš','ç§‘å¨ç‰¹','å‰å°”å‰æ–¯æ–¯å¦','è€æŒ','æ‹‰è„±ç»´äºš','é»å·´å«©','è±ç´¢æ‰˜','åˆ©æ¯”é‡Œäºš','åˆ©æ¯”äºš','ç«‹é™¶å®›','å¢æ£®å ¡','é©¬å…¶é¡¿','é©¬è¾¾åŠ æ–¯åŠ ','é©¬æ‹‰ç»´','é©¬æ¥','é©¬å°”ä»£å¤«','é©¬é‡Œ','é©¬è€³ä»–','æ¯›åˆ©å¡”å°¼äºš','æ¯›é‡Œæ±‚æ–¯','å¢¨è¥¿å“¥','æ‘©å°”å¤šç“¦','æ‘©çº³å“¥','è’™å¤','é»‘å±±å…±å’Œå›½','æ‘©æ´›å“¥','è«æ¡‘æ¯”å…‹','ç¼…ç”¸','çº³ç±³æ¯”äºš','å°¼æ³Šå°”','è·å…°','æ–°è¥¿å…°','å°¼åŠ æ‹‰ç“œ','å°¼æ—¥å°”','å°¼æ—¥åˆ©äºš','æœé²œ','æŒªå¨','é˜¿æ›¼','å·´åŸºæ–¯å¦','å·´æ‹¿é©¬','å·´æ‹‰åœ­','ç§˜é²','è²å¾‹å®¾','è‘¡è„ç‰™','æ³¢å¤šé»å„','å¡å¡”å°”','ç½—é©¬å°¼äºš','ä¿„ç½—æ–¯','å¢æ—ºè¾¾','åœ£é©¬åŠ›è¯º','æ²™ç‰¹é˜¿æ‹‰ä¼¯','å¡å†…åŠ å°”','å¡å°”ç»´äºš','å¡æ‹‰åˆ©æ˜‚','æ–¯æ´›ä¼å…‹','æ–¯æ´›æ–‡å°¼äºš','ç´¢é©¬é‡Œ','å—é','è¥¿ç­ç‰™','æ–¯é‡Œå…°å¡','è‹ä¸¹','è‹é‡Œå—','æ–¯å¨å£«å…°','ç‘å…¸','ç‘å£«','å™åˆ©äºš','å¡”å‰å…‹æ–¯å¦','å¦æ¡‘å°¼äºš','æ³°å›½','å¤šå“¥','æ±¤åŠ ','ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥','çªå°¼æ–¯','åœŸè€³å…¶','åœŸåº“æ›¼æ–¯å¦','ç¾å±ç»´å°”äº¬ç¾¤å²›','ä¹Œå¹²è¾¾','ä¹Œå…‹å…°','ä¹Œæ‹‰åœ­','ä¹Œå…¹åˆ«å…‹æ–¯å¦','å§”å†…ç‘æ‹‰','è¶Šå—','ä¹Ÿé—¨','èµæ¯”äºš','æ´¥å·´å¸ƒéŸ¦','å®‰é“å°”','ç•™å°¼æ±ª','æ³¢å…°','å…³å²›','æ¢µè’‚å†ˆ','åˆ—æ”¯æ•¦å£«ç™»','åº“æ‹‰ç´¢','å¡èˆŒå°”','å—æ','ç›´å¸ƒç½—é™€','å¤å·´','æ³•ç½—ç¾¤å²›','å¥¥å…°ç¾¤å²›','ç™¾æ…•è¾¾','ä¸œå¸æ±¶'];

// éœ€è¦æ’é™¤çš„å…³é”®è¯
const excludeKeywords = [
    /åˆ†å‰²/, /ä½™é¢/, /ç¾¤/, /åˆ°æœŸ/, /å‰©ä½™/, /é‡ç½®/, /å¥—é¤/, /å®˜ç½‘/, /10x/, 
    /ç½‘å€/, /ç½‘ç«™/, /å……å€¼/, /æ›´æ–°/, /åœ°å€/, /å›½å†…/, /æ°¸ä¹…/, /æ•™å­¦/, /com/, /www/, /69/, /è´­ä¹°/
];

// å…³é”®è¯å¯¹åº”å¤‡æ³¨ï¼ˆå·²åˆ é™¤â€œé«˜é€Ÿâ€å’Œâ€œä½é€Ÿâ€ï¼‰
const remarkKeywords = [
    { key: /ä¸“çº¿/, value: "DLine" }, // ä¸“çº¿ â†’ DLine
    { key: /å®¶å®½|å®¶åº­å®½å¸¦/, value: "HomB" },
    { key: /åŸç”Ÿ/, value: "Natv" },
    { key: /ç¦ä¸‹è½½/, value: "NoDL" },
    { key: /å¯é•¿æœŸä¸‹è½½/, value: "LTDL" },
    { key: /ç¦è§†é¢‘/, value: "NoVd" },
    { key: /ä¸‹è½½å‹¿ç”¨/, value: "NoDL" }
];

// é¢å¤–å¤‡æ³¨å…³é”®è¯
const extraRemarks = [
    { key: /æµ‹è¯•|Test/i, value: "Test" },
    { key: /Unmetered|æ— é™æµé‡/i, value: "UnLD" },
    { key: /EMBY/i, value: "Emby" }
];

// æ–°å¢äº”ä¸ªé«˜ä¼˜å…ˆçº§å¤‡æ³¨
const highPriorityRemarks = [
    { key: /IPLC/, value: "IPLC" },
    { key: /IEPL/, value: "IEPL" },
    { key: /BGP/, value: "BGP" },
    { key: /MPLS/, value: "MPLS" },
    { key: /MSTP/, value: "MSTP" }
];

function renameNodes(proxies) {
    let processedNodes = [];
    let countryGroups = {}; // æŒ‰å›½å®¶åˆ†ç»„å­˜å‚¨èŠ‚ç‚¹

    proxies.forEach((node) => {
        let name = node.name;

        // 1. è¿‡æ»¤åŒ…å«æ’é™¤å…³é”®è¯çš„èŠ‚ç‚¹
        if (excludeKeywords.some(regex => regex.test(name))) {
            return; // ç›´æ¥è·³è¿‡è¯¥èŠ‚ç‚¹
        }

        let country = "", flag = "", countryCode = "", countryCN = "";

        // 2. **ä¼˜å…ˆä½¿ç”¨å›½æ——è¯†åˆ«å›½å®¶**
        FG.forEach((emoji, index) => {
            if (name.includes(emoji)) {
                country = ZH[index];
                countryCN = ZH[index];
                flag = emoji;
                countryCode = EN[index];
            }
        });

        // 3. **å¦‚æœå›½æ——æœªè¯†åˆ«åˆ°å›½å®¶ï¼Œå†å°è¯•ä»åç§°ä¸­æå–**
        if (!country) {
            ZH.forEach((zhName, index) => {
                if (name.includes(zhName) || name.includes(EN[index])) {
                    country = zhName;
                    countryCN = zhName;
                    flag = FG[index];
                    countryCode = EN[index];
                }
            });
        }

        // 4. **å¦‚æœä»æ— æ³•è¯†åˆ«å›½å®¶ï¼Œè®¾ä¸ºâ€œæœªçŸ¥â€**
        if (!country) {
            flag = "ğŸŒ";
            countryCN = "æœªçŸ¥";
            countryCode = "Unknown";
        }

        // 5. è¯†åˆ«èŠ‚ç‚¹ç±»å‹
        let type = "AirP";
        if (/è‡ªå»º/.test(name)) type = "ZiJian";
        else if (/åˆç§Ÿ/.test(name)) type = "Hezu";

        // 6. è¯†åˆ«å¤‡æ³¨ä¿¡æ¯
        let remarks = [];

        // 6.1 åŸæœ‰å¤‡æ³¨åŒ¹é…
        extraRemarks.forEach(({ key, value }) => {
            if (key.test(name)) {
                remarks.push(value);
            }
        });

        // 6.2 å…³é”®è¯å¤‡æ³¨åŒ¹é…ï¼ˆå…ˆåŒ¹é…é«˜ä¼˜å…ˆçº§å¤‡æ³¨ï¼‰
        let hasHighPriorityRemark = false;
        highPriorityRemarks.forEach(({ key, value }) => {
            if (key.test(name)) {
                remarks.push(value);
                hasHighPriorityRemark = true; // æ ‡è®°å·²æ·»åŠ é«˜ä¼˜å…ˆçº§å¤‡æ³¨
            }
        });

        // 6.3 å¤„ç†â€œä¸“çº¿â€å¤‡æ³¨ï¼ˆå¦‚æœå·²æœ‰é«˜ä¼˜å…ˆçº§å¤‡æ³¨ï¼Œå°±ä¸åŠ  DLineï¼‰
        remarkKeywords.forEach(({ key, value }) => {
            if (key.test(name) && !remarks.includes(value) && !(hasHighPriorityRemark && value === "DLine")) {
                remarks.push(value);
            }
        });

        // 6.4 é¢å¤–å¤‡æ³¨ï¼šå®½å¸¦å¤§å°ï¼ˆå¦‚ 100Mbpsã€1Gbpsï¼‰
        let bandwidthMatch = name.match(/(\d+(\.\d+)?[MG]bps)/i);
        if (bandwidthMatch) {
            remarks.push(bandwidthMatch[1]);
        }

        // 7. è¯†åˆ«å€ç‡
        let multiplier = "1.0x";
        let multiplierMatch = name.match(/(?<!\d)(\d+(\.\d+)?)\s?[xXå€](?!\w)/);
        if (multiplierMatch) {
            multiplier = multiplierMatch[1] + "x";
        }

        // **å½“å€ç‡ä¸º 0.0x æ—¶ï¼Œæ·»åŠ æ— é™æµé‡æ ‡è¯†ï¼Œå¹¶ç§»é™¤ä½æµé‡è­¦å‘Š**
        if (multiplier === "0.0x") {
            remarks.push("UnLD");
        }

        // 8. ç»„åˆæœ€ç»ˆåç§°
        let finalName = `${flag} ${countryCN} ${countryCode} ${type}`;
        if (remarks.length > 0) finalName += ` ${remarks.join(" ")}`;
        finalName += ` - ${multiplier}`;

        // 9. **ä½æµé‡è­¦å‘Š**
        if (/ä½æµé‡/.test(name) && multiplier !== "0.0x") {
            finalName += " ğŸš¨";
        }

        // 10. æŒ‰å›½å®¶åˆ†ç»„å­˜å‚¨
        if (!countryGroups[countryCode]) {
            countryGroups[countryCode] = [];
        }
        countryGroups[countryCode].push({ name: finalName, originalNode: node });
    });

    // 11. **æŒ‰å›½å®¶æ’åºç¼–å·**
    Object.keys(countryGroups).forEach(countryCode => {
        // æŒ‰åç§°é•¿åº¦æ’åºï¼ŒçŸ­çš„æ’å‰
        countryGroups[countryCode].sort((a, b) => a.name.length - b.name.length);

        // é‡æ–°ç¼–å·
        countryGroups[countryCode].forEach((nodeData, index) => {
            let nodeNumber = String(index + 1).padStart(2, "0"); // ç¼–å·æ ¼å¼ 01, 02, ...
            nodeData.originalNode.name = `${nodeData.name.replace(" -", ` ${nodeNumber} -`)}`; // æ’å…¥ç¼–å·
            processedNodes.push(nodeData.originalNode);
        });
    });

    return processedNodes;
}

// å¤„ç†èŠ‚ç‚¹
const updatedNodes = renameNodes(proxies);
return updatedNodes;
